<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CollectJS Deep Investigation</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #00ff00;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .field-container {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #00ff00;
            border-radius: 5px;
        }
        #card-number-field, #card-expiry-field, #card-cvv-field {
            width: 100%;
            height: 50px;
            background: white;
            border: 2px solid #333;
            margin: 10px 0;
        }
        button {
            background: #00ff00;
            color: #1e1e1e;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        button:hover {
            background: #00cc00;
        }
        .log {
            background: #000;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #00ff00;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .section {
            margin: 30px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ CollectJS Deep Investigation</h1>
        
        <div class="section">
            <h2>Payment Fields</h2>
            <div class="field-container">
                <div id="card-number-field"></div>
                <div id="card-expiry-field"></div>
                <div id="card-cvv-field"></div>
            </div>
        </div>

        <div class="section">
            <h2>Investigation Controls</h2>
            <button onclick="investigateCollectJS()">üîç Investigate CollectJS Object</button>
            <button onclick="tryDirectIframeAccess()">üéØ Try Direct Iframe Access</button>
            <button onclick="tryPostMessage()">üìÆ Try PostMessage</button>
            <button onclick="tryDispatchEvents()">‚ö° Try Dispatch Events</button>
            <button onclick="tryProgrammaticFill()">ü§ñ Try Programmatic Fill</button>
            <button onclick="checkForHiddenMethods()">üïµÔ∏è Check Hidden Methods</button>
            <button onclick="tryWebDriverApproach()">üöó Try WebDriver Approach</button>
            <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>

        <div class="section">
            <h2>Log Output</h2>
            <div id="log" class="log"></div>
        </div>
    </div>

    <!-- Load CollectJS -->
    <script 
        src="https://secure.networkmerchants.com/token/Collect.js" 
        data-tokenization-key="vZ668s-j859wu-6THDmy-kA46Hh">
    </script>

    <script>
        const log = (message, data = null) => {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            let output = `[${timestamp}] ${message}`;
            if (data) {
                output += '\n' + JSON.stringify(data, null, 2);
            }
            logEl.textContent += output + '\n\n';
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message, data);
        };

        const clearLog = () => {
            document.getElementById('log').textContent = '';
        };

        // Initialize CollectJS when ready
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (window.CollectJS) {
                    log('‚úÖ CollectJS loaded, initializing...');
                    
                    window.CollectJS.configure({
                        variant: 'inline',
                        styleSniffer: true,
                        fields: {
                            ccnumber: {
                                selector: '#card-number-field',
                                title: 'Card Number',
                                placeholder: '4111 1111 1111 1111'
                            },
                            ccexp: {
                                selector: '#card-expiry-field',
                                title: 'Expiry Date',
                                placeholder: '12/25'
                            },
                            cvv: {
                                selector: '#card-cvv-field',
                                title: 'CVV',
                                placeholder: '123'
                            }
                        },
                        fieldsAvailableCallback: () => {
                            log('‚úÖ CollectJS fields are ready');
                            // Auto-investigate after fields are ready
                            setTimeout(investigateCollectJS, 1000);
                        },
                        callback: (response) => {
                            log('Token response:', response);
                        }
                    });
                } else {
                    log('‚ùå CollectJS not loaded');
                }
            }, 1000);
        });

        const investigateCollectJS = () => {
            log('üîç Investigating CollectJS object...');
            
            if (!window.CollectJS) {
                log('‚ùå CollectJS not found');
                return;
            }

            // Get all properties
            const props = Object.getOwnPropertyNames(window.CollectJS);
            log('CollectJS properties:', props);

            // Check prototype
            const proto = Object.getPrototypeOf(window.CollectJS);
            if (proto) {
                const protoProps = Object.getOwnPropertyNames(proto);
                log('CollectJS prototype properties:', protoProps);
            }

            // Try to access internal properties
            for (const prop of props) {
                try {
                    const value = window.CollectJS[prop];
                    const type = typeof value;
                    if (type === 'function') {
                        log(`Method found: CollectJS.${prop}()`);
                        // Try to get function source
                        try {
                            const source = value.toString().substring(0, 200);
                            log(`  Source preview: ${source}...`);
                        } catch (e) {}
                    } else if (type === 'object' && value !== null) {
                        log(`Object property: CollectJS.${prop}`, Object.keys(value));
                    }
                } catch (e) {
                    log(`Cannot access: CollectJS.${prop}`);
                }
            }

            // Check for hidden properties
            const hidden = ['_fields', 'fields', 'config', '_config', 'options', '_options', 
                           'setValue', 'setFieldValue', 'fillField', 'populate', 'prefill',
                           'setValues', 'updateField', 'updateValue', 'autoFill'];
            
            for (const prop of hidden) {
                if (window.CollectJS[prop] !== undefined) {
                    log(`Hidden property found: CollectJS.${prop}`, window.CollectJS[prop]);
                }
            }
        };

        const tryDirectIframeAccess = () => {
            log('üéØ Attempting direct iframe access...');
            
            const containers = ['#card-number-field', '#card-expiry-field', '#card-cvv-field'];
            
            containers.forEach(selector => {
                const container = document.querySelector(selector);
                if (container) {
                    const iframe = container.querySelector('iframe');
                    if (iframe) {
                        log(`Found iframe in ${selector}`);
                        
                        try {
                            // Try to access contentWindow
                            const win = iframe.contentWindow;
                            log(`  contentWindow accessible: ${!!win}`);
                            
                            if (win) {
                                // Try to access document
                                try {
                                    const doc = win.document;
                                    log(`  contentDocument accessible: ${!!doc}`);
                                    
                                    if (doc) {
                                        const input = doc.querySelector('input');
                                        if (input) {
                                            log(`  Found input field!`);
                                            input.value = '4111111111111111';
                                            input.dispatchEvent(new Event('input'));
                                            log(`  ‚úÖ Value set successfully!`);
                                        }
                                    }
                                } catch (e) {
                                    log(`  ‚ùå Cross-origin blocked: ${e.message}`);
                                }
                            }
                        } catch (e) {
                            log(`  ‚ùå Error: ${e.message}`);
                        }
                    }
                }
            });
        };

        const tryPostMessage = () => {
            log('üìÆ Attempting PostMessage communication...');
            
            const iframe = document.querySelector('#card-number-field iframe');
            if (iframe && iframe.contentWindow) {
                // Try various message formats
                const messages = [
                    { action: 'setValue', field: 'ccnumber', value: '4111111111111111' },
                    { type: 'SET_VALUE', data: '4111111111111111' },
                    { command: 'fill', value: '4111111111111111' },
                    '4111111111111111'
                ];
                
                messages.forEach((msg, i) => {
                    try {
                        iframe.contentWindow.postMessage(msg, '*');
                        log(`  Sent message ${i + 1}:`, msg);
                    } catch (e) {
                        log(`  ‚ùå Failed to send message ${i + 1}: ${e.message}`);
                    }
                });
                
                // Listen for responses
                window.addEventListener('message', (e) => {
                    if (e.source === iframe.contentWindow) {
                        log('  üì® Received response:', e.data);
                    }
                });
            }
        };

        const tryDispatchEvents = () => {
            log('‚ö° Attempting to dispatch events...');
            
            const iframe = document.querySelector('#card-number-field iframe');
            if (iframe) {
                // Try dispatching events to the iframe itself
                const events = [
                    new CustomEvent('collectjs-fill', { detail: { value: '4111111111111111' } }),
                    new CustomEvent('fill', { detail: '4111111111111111' }),
                    new KeyboardEvent('keydown', { key: '4' }),
                    new InputEvent('input', { data: '4111111111111111' })
                ];
                
                events.forEach((event, i) => {
                    try {
                        iframe.dispatchEvent(event);
                        log(`  Dispatched event ${i + 1}: ${event.type}`);
                    } catch (e) {
                        log(`  ‚ùå Failed to dispatch event ${i + 1}: ${e.message}`);
                    }
                });
            }
        };

        const tryProgrammaticFill = () => {
            log('ü§ñ Attempting programmatic fill methods...');
            
            // Method 1: Try to trigger CollectJS internal methods
            if (window.CollectJS) {
                // Try various potential methods
                const methods = [
                    () => window.CollectJS.setValue && window.CollectJS.setValue('ccnumber', '4111111111111111'),
                    () => window.CollectJS.setFieldValue && window.CollectJS.setFieldValue('ccnumber', '4111111111111111'),
                    () => window.CollectJS.updateField && window.CollectJS.updateField('ccnumber', '4111111111111111'),
                    () => window.CollectJS.fields && window.CollectJS.fields.ccnumber && window.CollectJS.fields.ccnumber.setValue('4111111111111111'),
                ];
                
                methods.forEach((method, i) => {
                    try {
                        const result = method();
                        if (result !== undefined) {
                            log(`  Method ${i + 1} returned:`, result);
                        }
                    } catch (e) {
                        log(`  Method ${i + 1} failed: ${e.message}`);
                    }
                });
            }
            
            // Method 2: Try to modify the configuration
            try {
                if (window.CollectJS && window.CollectJS.configure) {
                    log('  Trying to reconfigure with default values...');
                    // This won't work but worth trying
                    window.CollectJS.configure({
                        fields: {
                            ccnumber: {
                                selector: '#card-number-field',
                                value: '4111111111111111' // Try adding value property
                            }
                        }
                    });
                }
            } catch (e) {
                log(`  Reconfigure failed: ${e.message}`);
            }
        };

        const checkForHiddenMethods = () => {
            log('üïµÔ∏è Checking for hidden/undocumented methods...');
            
            if (!window.CollectJS) return;
            
            // Use reflection to find all properties
            const getAllProperties = (obj) => {
                const props = new Set();
                let current = obj;
                do {
                    Object.getOwnPropertyNames(current).forEach(prop => props.add(prop));
                } while ((current = Object.getPrototypeOf(current)));
                return Array.from(props);
            };
            
            const allProps = getAllProperties(window.CollectJS);
            log('All properties (including inherited):', allProps);
            
            // Check window for CollectJS related objects
            for (const key in window) {
                if (key.toLowerCase().includes('collect') || key.toLowerCase().includes('nmi')) {
                    log(`Window property found: window.${key}`, typeof window[key]);
                }
            }
        };

        const tryWebDriverApproach = () => {
            log('üöó Trying WebDriver-style approach...');
            
            // This simulates what Selenium WebDriver would do
            const iframe = document.querySelector('#card-number-field iframe');
            if (iframe) {
                // Create and dispatch native events
                const simulateTyping = (element, value) => {
                    element.focus();
                    element.value = '';
                    
                    for (const char of value) {
                        const keydownEvent = new KeyboardEvent('keydown', {
                            key: char,
                            code: `Digit${char}`,
                            charCode: char.charCodeAt(0),
                            keyCode: char.charCodeAt(0),
                            which: char.charCodeAt(0),
                            bubbles: true
                        });
                        
                        const inputEvent = new InputEvent('input', {
                            data: char,
                            inputType: 'insertText',
                            bubbles: true
                        });
                        
                        element.dispatchEvent(keydownEvent);
                        element.value += char;
                        element.dispatchEvent(inputEvent);
                    }
                    
                    element.dispatchEvent(new Event('change', { bubbles: true }));
                };
                
                try {
                    // Try to execute in iframe context
                    iframe.contentWindow.eval(`
                        const input = document.querySelector('input');
                        if (input) {
                            input.value = '4111111111111111';
                            input.dispatchEvent(new Event('input'));
                            console.log('Set value via eval');
                        }
                    `);
                    log('  ‚úÖ Eval executed');
                } catch (e) {
                    log(`  ‚ùå Eval blocked: ${e.message}`);
                }
            }
        };
    </script>
</body>
</html>